<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div id="root"></div>
    <script>
        const rootDom = document.getElementById("root");

        // --------------- è¿è¡Œä¸€æ¬¡ å¼€å§‹------
        let rootInstance = null;

        function render(element, container) {

            const prevInstance = rootInstance; // 1-è™šæ‹Ÿdomä¸»æ ‘å¹²- == null
            const nextInstance = reconcile(container, prevInstance, element);
            rootInstance = nextInstance; // 2-æ”¯æ ‘å¹²- é¢†å¤´å•¦
        }

        function reconcile(parentDom, instance, element) {
            if (instance == null) {
                // ä¸€å¼€å§‹çš„ 1-è™šæ‹Ÿdomä¸»æ ‘å¹²- null
                const newInstance = instantiate(element); // ä»Žä¸€ä¸ªÂ·Didactå…ƒç´ Â·-> å®žä¾‹
                parentDom.appendChild(newInstance.dom); // -html-å…ƒç´ æ·»åŠ 
                return newInstance;
            } else {
                const newInstance = instantiate(element);
                parentDom.replaceChild(newInstance.dom, instance.dom);
                return newInstance;
            }
        }

        // --------------- è¿è¡Œä¸€æ¬¡ ç»“æŸ------

        // ------ é€’å½’ - instantiate - è¿è¡Œä¸€æ¬¡ä»¥ä¸Š -----
        function instantiate(element) {
            const { type, props } = element;

            // Create DOM element
            const isTextElement = type === "TEXT ELEMENT";
            const dom = isTextElement
                ? document.createTextNode("")
                : document.createElement(type);

            // Add event listeners
            const isListener = name => name.startsWith("on");
            Object.keys(props).filter(isListener).forEach(name => {
                const eventType = name.toLowerCase().substring(2);
                dom.addEventListener(eventType, props[name]);
            });

            // Set properties
            const isAttribute = name => !isListener(name) && name != "children";
            Object.keys(props).filter(isAttribute).forEach(name => {
                dom[name] = props[name];
            });
            // 1. dom æž„é€ å®Œæˆ

            // Instantiate and append children
            const childElements = props.children || [];

            // 2. è½¬æŠ˜ç‚¹-é€’å½’-å­©å­ -> å˜ å®žä¾‹æ•°ç»„
            const childInstances = childElements.map(instantiate);
            // 3. èŽ·å– å­©å­-html-æ•°ç»„
            const childDoms = childInstances.map(childInstance => childInstance.dom);

            // 4. å„¿/å¥³ åŠ å…¥ çˆ¸çˆ¸å¦ˆå¦ˆçš„æ€€æŠ±, ã€Œ html ç»„åˆ ã€
            // æ­£å¦‚ -2- æ‰€åšçš„-é€’å½’æœ¬å‡½æ•°
            // æ‰€ä»¥-å­™å­/å­™å¥³-å·²ç»-åŠ å…¥-å„¿/å¥³çš„æ€€æŠ±äº†
            childDoms.forEach(childDom => dom.appendChild(childDom));

            const instance = { dom, element, childInstances };

            // `element` -> `Didact å…ƒç´ `

            // `dom` -> `html å…ƒç´ `

            // `childInstances`æ˜¯ä¸€ä¸ªåŒ…å«å…ƒç´ -å­å…ƒç´ å®žä¾‹çš„æ•°ç»„ã€‚

            return instance;
        }

        function tick() {
            const time = new Date().toLocaleTimeString();
            const clockElement = createElement("h1", null, time);
            render(clockElement, rootDom);
        }

        tick();
        setInterval(tick, 1000);

        /** â¬‡ï¸â¬‡ï¸â¬‡ï¸â¬‡ï¸â¬‡ï¸ ðŸŒ¼DidactðŸŒ¼ â¬‡ï¸â¬‡ï¸â¬‡ï¸â¬‡ï¸â¬‡ï¸ **/

        function createElement(type, config, ...args) {
            const props = Object.assign({}, config);
            const hasChildren = args.length > 0;
            const rawChildren = hasChildren ? [].concat(...args) : [];
            props.children = rawChildren.
                filter(c => c != null && c !== false).
                map(c => c instanceof Object ? c : createTextElement(c));
            return { type, props };
        }

        function createTextElement(value) {
            return createElement("TEXT ELEMENT", { nodeValue: value });
        }
    </script>
</body>

</html>